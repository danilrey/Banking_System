<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>Freedom Bank — Cards</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="/assets/css/base.css">
    <link rel="stylesheet" href="/assets/css/components.css">
    <style>
        body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text",sans-serif;background:radial-gradient(circle at top left,#0b1a33 0,#020817 55%,#000 100%);color:#e5e9f0}
        a{color:inherit;text-decoration:none}
        .app-shell{display:grid;grid-template-columns:260px minmax(0,1fr);min-height:100vh}
        .sidebar{border-right:1px solid rgba(255,255,255,.06);background:linear-gradient(180deg,rgba(8,15,35,.98),rgba(2,8,15,.98));padding:20px 18px;display:flex;flex-direction:column;gap:22px}
        .brand{display:flex;align-items:center;gap:10px}
        .brand__logo{width:32px;height:32px;border-radius:999px;display:inline-flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#22c55e,#16a34a);font-weight:700;font-size:.95rem;color:#020617;box-shadow:0 0 0 0 rgba(34,197,94,.5);animation:pulse 2.4s ease-in-out infinite}
        .brand__name{font-weight:600;font-size:1rem}
        .brand__subtitle{font-size:.78rem;opacity:.6}
        .user-card{padding:12px;border-radius:16px;background:rgba(15,23,42,.85);border:1px solid rgba(148,163,184,.12)}
        .user-card__status{display:flex;align-items:center;gap:8px;font-size:.72rem;letter-spacing:.08em;text-transform:uppercase;color:#22c55e}
        .nav-title{font-size:.78rem;text-transform:uppercase;letter-spacing:.12em;opacity:.55}
        .nav-list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:6px}
        .nav-item{border-radius:12px;display:flex;align-items:center;gap:10px;padding:10px 12px;opacity:.9;transition:transform .12s ease,background .18s ease,opacity .18s ease}
        .nav-item:hover{transform:translateX(2px);background:rgba(148,163,184,.12);opacity:1}
        .nav-item--active{background:rgba(34,197,94,.16);color:#bbf7d0;box-shadow:inset 0 0 0 1px rgba(34,197,94,.25)}
        .nav-caption{margin-left:auto;font-size:.74rem;opacity:.65}
        .nav-icon{width:18px;height:18px;opacity:.9}
        .main{padding:22px 28px 32px}
        .page-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:18px}
        .page-title{font-size:1.35rem;font-weight:600}
        .page-subtitle{font-size:.92rem;opacity:.72}
        .card{border-radius:16px;background:radial-gradient(circle at top left,rgba(15,23,42,.95),rgba(5,10,25,.98));border:1px solid rgba(148,163,184,.16);padding:14px}
        .table{width:100%;border-collapse:collapse;font-size:.85rem}
        .table th,.table td{padding:10px;border-bottom:1px solid rgba(30,41,59,.9)}
        .table thead{background:rgba(15,23,42,.9)}
        .badge{font-size:.72rem;padding:2px 8px;border-radius:999px;border:1px solid transparent}
        .badge--success{background:rgba(22,163,74,.18);border-color:rgba(34,197,94,.5);color:#bbf7d0}
        .badge--muted{background:rgba(30,64,175,.14);border-color:rgba(129,140,248,.55);color:#c7d2fe}
        .pill{font-size:.72rem;padding:2px 8px;border-radius:999px;background:rgba(148,163,184,.14);border:1px solid rgba(148,163,184,.22)}
        .row-click{cursor:pointer}
        .row-click:hover td{background:rgba(15,23,42,.8)}
        /* Drawer */
        .drawer{position:fixed;top:0;right:-420px;width:420px;max-width:100%;height:100dvh;background:rgba(10,15,25,.98);border-left:1px solid rgba(148,163,184,.16);box-shadow:-20px 0 40px rgba(0,0,0,.35);transition:right .26s ease;z-index:60;display:flex;flex-direction:column}
        .drawer--open{right:0}
        .drawer__header{display:flex;align-items:center;justify-content:space-between;padding:16px;border-bottom:1px solid rgba(148,163,184,.16)}
        .drawer__body{padding:16px;overflow:auto}
        .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(148,163,184,.22);background:transparent;border-radius:999px;padding:8px 12px;font-size:.86rem;cursor:pointer;transition:transform .1s ease,border-color .18s ease}
        .btn:hover{transform:translateY(-1px);border-color:rgba(148,163,184,.38)}
        .btn--primary{background:linear-gradient(90deg,#22c55e,#16a34a);border-color:transparent;color:#020617;font-weight:600}
        .footer{margin-top:auto;font-size:.78rem;opacity:.55}
        @keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(34,197,94,0)}50%{box-shadow:0 0 0 10px rgba(34,197,94,.08)}}
        @media(max-width:960px){.app-shell{grid-template-columns:1fr}.sidebar{flex-direction:row;gap:16px;overflow-x:auto}.footer{display:none}}
    </style>
</head>
<body>
<!-- Icons -->
<svg width="0" height="0" style="position:absolute"><defs>
    <symbol id="ic-dashboard" viewBox="0 0 24 24"><path fill="currentColor" d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></symbol>
    <symbol id="ic-accounts" viewBox="0 0 24 24"><path fill="currentColor" d="M4 6h16v2H4zm0 5h16v2H4zm0 5h10v2H4z"/></symbol>
    <symbol id="ic-cards" viewBox="0 0 24 24"><path fill="currentColor" d="M2 6h20v12H2zM2 9h20"/></symbol>
    <symbol id="ic-loans" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2l9 5v10l-9 5-9-5V7z"/></symbol>
    <symbol id="ic-deposits" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2a7 7 0 017 7c0 5-7 13-7 13S5 14 5 9a7 7 0 017-7zm0 9a2 2 0 100-4 2 2 0 000 4z"/></symbol>
    <symbol id="ic-logout" viewBox="0 0 24 24"><path fill="currentColor" d="M16 13v-2H7V8l-5 4 5 4v-3zM20 3h-8v2h8v14h-8v2h8a2 2 0 002-2V5a2 2 0 00-2-2z"/></symbol>
    <symbol id="ic-close" viewBox="0 0 24 24"><path fill="currentColor" d="M18.3 5.7L12 12l6.3 6.3-1.4 1.4L10.6 13.4 4.3 19.7 2.9 18.3 9.2 12 2.9 5.7 4.3 4.3l6.3 6.3 6.3-6.3z"/></symbol>
    <symbol id="ic-eye" viewBox="0 0 24 24"><path fill="currentColor" d="M12 5C7 5 2.7 8 1 12c1.7 4 6 7 11 7s9.3-3 11-7c-1.7-4-6-7-11-7zm0 12a5 5 0 110-10 5 5 0 010 10z"/></symbol>
</defs></svg>

<div class="app-shell">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="brand">
            <div class="brand__logo">FB</div>
            <div>
                <div class="brand__name">Freedom Bank</div>
                <div class="brand__subtitle">Online banking</div>
            </div>
        </div>

        <div class="user-card">
            <div class="user-card__status"><span>●</span><span>ONLINE</span></div>
            <div style="font-weight:600;margin-top:6px">admin</div>
            <div style="opacity:.75">Administrator</div>
        </div>

        <div>
            <div class="nav-title">Navigation</div>
            <ul class="nav-list">
                <li class="nav-item">
                    <a class="nav-link" href="dashboard.html" style="display:flex;align-items:center;gap:10px">
                        <svg class="nav-icon"><use href="#ic-dashboard"/></svg><span>Dashboard</span>
                    </a>
                    <span class="nav-caption">overview</span>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="accounts.html" style="display:flex;align-items:center;gap:10px">
                        <svg class="nav-icon"><use href="#ic-accounts"/></svg><span>Accounts</span>
                    </a>
                    <span class="nav-caption">balance & details</span>
                </li>
                <li class="nav-item nav-item--active">
                    <a class="nav-link" href="cards.html" style="display:flex;align-items:center;gap:10px">
                        <svg class="nav-icon"><use href="#ic-cards"/></svg><span>Cards</span>
                    </a>
                    <span class="nav-caption">limits & statements</span>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="credits.html" style="display:flex;align-items:center;gap:10px">
                        <svg class="nav-icon"><use href="#ic-loans"/></svg><span>Loans</span>
                    </a>
                    <span class="nav-caption">payment schedule</span>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="deposits.html" style="display:flex;align-items:center;gap:10px">
                        <svg class="nav-icon"><use href="#ic-deposits"/></svg><span>Deposits</span>
                    </a>
                    <span class="nav-caption">savings</span>
                </li>
            </ul>
        </div>

        <div>
            <div class="nav-title">Actions</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
                <a class="btn" href="profile.html">Profile</a>
                <button id="logoutBtn" class="btn"><svg class="nav-icon"><use href="#ic-logout"/></svg><span>Sign out</span></button>
            </div>
        </div>

        <div class="footer">Freedom Bank © 2025</div>
    </aside>

    <!-- Main -->
    <main class="main">
        <header class="page-header">
            <div>
                <div class="page-title">Cards</div>
                <div class="page-subtitle">Manage debit and credit cards</div>
            </div>
        </header>

        <section class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                <div style="font-weight:600;opacity:.85">Your cards</div>
                <button id="refreshBtn" class="btn">
                    <svg class="nav-icon"><use href="#ic-eye"/></svg><span>Refresh</span>
                </button>
            </div>

            <table class="table" id="cardsTable">
                <thead>
                <tr>
                    <th>Card</th>
                    <th>Account</th>
                    <th>Holder</th>
                    <th>Status</th>
                    <th>Expiry</th>
                    <th>Limits</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>
    </main>
</div>

<!-- Drawer (card details) -->
<aside class="drawer" id="cardDrawer" aria-hidden="true">
    <div class="drawer__header">
        <div style="font-weight:600">Card details</div>
        <button id="drawerClose" class="btn" aria-label="Close">
            <svg class="nav-icon"><use href="#ic-close"/></svg> Close
        </button>
    </div>
    <div class="drawer__body">
        <div id="drawerBody" style="display:grid;gap:10px"></div>
        <div style="display:flex;gap:8px;margin-top:12px">
            <button class="btn btn--primary" id="btnFreeze">Freeze card</button>
            <button class="btn" id="btnLimits">Edit limits</button>
        </div>
    </div>
</aside>

<div id="toastContainer" class="hidden"></div>

<script type="module">
    import {requireAuth, logout} from '/assets/js/core/auth.js';
    import {bindLogout, showToast} from '/assets/js/core/ui.js';
    import {cardApi} from '/assets/js/api/cardApi.js';

    if (!requireAuth()) { window.location.href = '/index.html'; }

    bindLogout('logoutBtn', logout);

    document.querySelectorAll('.nav-list a').forEach(a=>{
      if (a.getAttribute('href') && location.pathname.endsWith(a.getAttribute('href'))) {
        a.closest('.nav-item')?.classList.add('nav-item--active');
      }
    });

    const tbody = document.querySelector('#cardsTable tbody');
    const refreshBtn = document.getElementById('refreshBtn');
    const drawer = document.getElementById('cardDrawer');
    const drawerClose = document.getElementById('drawerClose');
    const drawerBody = document.getElementById('drawerBody');
    const btnFreeze = document.getElementById('btnFreeze');
    const btnLimits = document.getElementById('btnLimits');

    let currentCard = null;

    refreshBtn.addEventListener('click', loadCards);
    drawerClose.addEventListener('click', closeDrawer);
    btnFreeze.addEventListener('click', () => {
      if (!currentCard) return;
      showToast('Action', `Freeze card #${currentCard.id} — stub`);
    });
    btnLimits.addEventListener('click', () => {
      if (!currentCard) return;
      showToast('Action', `Edit limits for card #${currentCard.id} — stub`);
    });

    async function loadCards(){
      tbody.innerHTML = '';
      try{
        const cards = await cardApi.myCards();
        if (!cards || cards.length === 0){
          tbody.innerHTML = `<tr><td colspan="6" style="opacity:.7">No cards yet</td></tr>`;
          return;
        }
        for (const c of cards){
          const last4 = String(c.cardNumber ?? '').slice(-4).padStart(4,'•');
          const row = document.createElement('tr');
          row.className = 'row-click';
          row.innerHTML = `
            <td>**** **** **** ${last4}</td>
            <td>${c.accountId ?? ''}</td>
            <td>${c.holderName ?? '—'}</td>
            <td><span class="badge ${c.status==='ACTIVE'?'badge--success':'badge--muted'}">${c.status}</span></td>
            <td>${(c.expiryMonth??'')}/${(c.expiryYear??'')}</td>
            <td><span class="pill">${c.dailyLimit ? \`\${c.dailyLimit} \${c.currency||'KZT'} daily\` : '—'}</span></td>
          `;
          row.addEventListener('click', ()=>openDrawer(c));
          tbody.appendChild(row);
        }
      }catch(e){
        tbody.innerHTML = `<tr><td colspan="6" style="color:#fb7185">Failed to load cards</td></tr>`;
      }
    }

    function openDrawer(card){
      currentCard = card;
      const masked = '**** **** **** ' + String(card.cardNumber ?? '').slice(-4).padStart(4,'•');
      drawerBody.innerHTML = `
        <div><div style="opacity:.7;font-size:.85rem">Card</div><div style="font-weight:600">${masked}</div></div>
        <div><div style="opacity:.7;font-size:.85rem">Account</div><div>${card.accountId ?? ''}</div></div>
        <div><div style="opacity:.7;font-size:.85rem">Holder</div><div>${card.holderName ?? '—'}</div></div>
        <div><div style="opacity:.7;font-size:.85rem">Status</div>
          <div><span class="badge ${card.status==='ACTIVE'?'badge--success':'badge--muted'}">${card.status}</span></div>
        </div>
        <div><div style="opacity:.7;font-size:.85rem">Expiry</div><div>${(card.expiryMonth??'')}/${(card.expiryYear??'')}</div></div>
        <div><div style="opacity:.7;font-size:.85rem">Limits</div><div>${card.dailyLimit ? (card.dailyLimit+' '+(card.currency||'KZT')+' daily') : '—'}</div></div>
      `;
      drawer.classList.add('drawer--open');
      drawer.setAttribute('aria-hidden','false');
    }

    function closeDrawer(){
      drawer.classList.remove('drawer--open');
      drawer.setAttribute('aria-hidden','true');
      currentCard = null;
    }

    // Initial load
    loadCards();
</script>
</body>
</html>
